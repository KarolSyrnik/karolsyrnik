<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Karteikarten</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#f2f2f2;
  --card:#ffffff;
  --text:#1a1a1a;
  --bar:#d9d9d9;
  --border:#cfcfcf;
  --shadow:0 16px 65px rgba(0,0,0,.25);

  --ui:#ffffff;
  --uiBorder:#d0d0d0;
  --uiHover:#f3f3f3;
}
[data-theme="dark"]{
  --bg:#000000;
  --card:#0b0b0b;
  --text:#eaeaea;
  --bar:#1a1a1a;
  --border:#2a2a2a;
  --shadow:0 22px 80px rgba(0,0,0,.85);

  --ui:#0c0c0c;
  --uiBorder:#2a2a2a;
  --uiHover:#141414;
}

*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:var(--bg);
  font-family:system-ui,Segoe UI,Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  color:var(--text);
}

.page{width:100%}
.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 28px;
}
.controls{
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}
#counter{font-weight:800; opacity:.75}

/* UI */
.btn{
  background:var(--ui);
  color:var(--text);
  border:1px solid var(--uiBorder);
  border-radius:14px;
  padding:10px 16px;
  font-weight:800;
  cursor:pointer;
  transition:.15s;
}
.btn:hover{background:var(--uiHover)}
.btn:active{transform:scale(.98)}

/* FILE MENU */
.fileBox{
  display:flex;
  align-items:center;
  gap:10px;
  background:var(--ui);
  border:1px solid var(--uiBorder);
  border-radius:16px;
  padding:8px 10px;
  position:relative;
}
.fileBox label{
  padding:8px 14px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  background:var(--uiHover);
}
.fileBox input{display:none}

.fileBtn{
  border:none;
  background:none;
  color:var(--text);
  font-weight:900;
  cursor:pointer;
  padding:8px 12px;
  border-radius:12px;
  display:flex;
  align-items:center;
  gap:8px;
}
.fileBtn:hover{background:var(--uiHover)}

.fileName{
  max-width:180px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.menu{
  position:absolute;
  top:58px;
  left:0;
  width:320px;
  max-width:90vw;
  background:var(--ui);
  border:1px solid var(--uiBorder);
  border-radius:16px;
  box-shadow:0 25px 80px rgba(0,0,0,.45);
  padding:8px;
  display:none;
  z-index:999;
}
.menu.open{display:block}
.menuTitle{
  font-weight:900;
  opacity:.75;
  padding:10px 10px 8px 10px;
}
.menuItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 10px;
  border-radius:12px;
  cursor:pointer;
  transition:.12s;
}
.menuItem:hover{background:var(--uiHover)}
.menuItemName{
  font-weight:800;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.trash{
  border:none;
  background:none;
  font-size:18px;
  cursor:pointer;
  opacity:.75;
  color: var(--text);
}
[data-theme="dark"] .trash{color:#fff; opacity:.9}
[data-theme="dark"] .trash:hover{opacity:1}

/* CENTER */
.center{
  position:relative;
  width:100%;
  height:calc(100vh - 110px);
  display:flex;
  justify-content:center;
  align-items:center;
}

/* ARROWS */
.arrow{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  background:none;
  border:none;
  font-size:56px;
  font-weight:700;
  color:var(--text);
  cursor:pointer;
  opacity:.55;
  transition:.15s;
}
.arrow:hover{opacity:1}
.arrow.left{
  left:70px;
  transform:translateY(-50%) scaleX(-1);
}
.arrow.right{right:70px}

/* CARD */
.card{
  width:16cm;
  height:11.5cm;
  perspective:1400px;
  max-width:90vw;
  max-height:80vh;
}
.inner{
  width:100%;
  height:100%;
  position:relative;
  transform-style:preserve-3d;
  transition:.45s;
  cursor:pointer;
}
.card.flipped .inner{transform:rotateY(180deg)}

.face{
  position:absolute;
  inset:0;
  background:var(--card);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  backface-visibility:hidden;
  overflow:hidden;
}
.back{transform:rotateY(180deg)}

/* HEADER */
.header{
  position:absolute;
  top:16px; left:16px; right:16px;
  height:36px;
  background:var(--bar);
  display:flex;
  align-items:center;
  padding:0 16px;
  font-weight:900;
  border-radius:8px;
}
.pageNo{margin-left:auto; opacity:.6}

/* VERTICAL LABEL */
.vlabel{
  position:absolute;
  left:16px;
  top:120px;
  bottom:40px;
  width:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
.vlabel span{
  transform:rotate(-90deg);
  font-size:52px;
  font-weight:900;
  opacity:.07;
}

/* CONTENT (SCROLL FIX) */
.content{
  position:absolute;
  top:110px;
  left:130px;
  right:50px;
  bottom:60px;

  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;

  overflow:auto;
  padding:10px 10px;
}
.content::-webkit-scrollbar{width:10px}
.content::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,.15);
  border-radius:10px;
}
[data-theme="dark"] .content::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.18);
}

.question{
  font-size:22px;
  font-weight:700;
}

.difficulty{
  display:flex;
  gap:8px;
  margin-top:14px;
}
.dot{
  width:11px;
  height:11px;
  border-radius:50%;
  border:2px solid var(--text);
  opacity:.3;
}
.dot.active{background:var(--text); opacity:1}

/* BACK */
.answerWrap{
  width:100%;
  display:flex;
  flex-direction:column;
  gap:14px;
  text-align:left;
  max-height:100%;
}
.solutionTitle{
  font-size:18px;
  font-weight:900;
  opacity:.95;
}
.answerText{
  font-size:17px;
  line-height:1.5;
  white-space:pre-wrap;
  text-align:left;
  width:100%;
}

/* MOBILE */
@media (max-width: 700px){
  .top{
    padding:12px 12px;
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
  }
  .controls{
    width:100%;
    justify-content:space-between;
  }
  #counter{
    width:100%;
    text-align:right;
  }
  .btn{
    padding:8px 12px;
    border-radius:12px;
    font-size:14px;
  }
  .fileBox{
    width:100%;
    justify-content:space-between;
  }
  .fileName{max-width:120px}

  .center{
    height:calc(100vh - 150px);
    padding-bottom:80px;
  }

  .card{
    width:min(94vw, 16cm);
    height:calc(min(94vw, 16cm) * (11.5 / 16));
    max-height:60vh;
  }

  .arrow{
    top:auto;
    bottom:70px;
    transform:none;
    font-size:46px;
  }
  .arrow.left{
    left:20px;
    transform:scaleX(-1);
  }
  .arrow.right{right:20px}

  .content{
    left:105px;
    right:24px;
    top:95px;
    bottom:50px;
  }

  .vlabel{top:110px; width:55px}
  .vlabel span{font-size:44px}

  .question{font-size:18px}
  .answerText{font-size:15px}
  .solutionTitle{font-size:16px}
}
</style>
</head>
<body>

<div class="page">

  <div class="top">
    <div class="controls">

      <div class="fileBox" id="fileBox">
        <label for="fileInput">ðŸ“„ TXT</label>
        <input type="file" id="fileInput" accept=".txt" multiple>

        <button class="fileBtn" id="fileBtn" type="button">
          <span class="fileName" id="activeFileName">TXT wÃ¤hlenâ€¦</span>
          <span>â–¾</span>
        </button>

        <div class="menu" id="menu">
          <div class="menuTitle">Gespeicherte TXT-Dateien</div>
          <div id="menuList"></div>
        </div>
      </div>

      <button class="btn" type="button" onclick="toggleTheme()">ðŸŒ— Theme</button>
    </div>

    <div id="counter"></div>
  </div>

  <div class="center">
    <button class="arrow left" type="button" onclick="prev()">âžœ</button>

    <div class="card" id="card">
      <div class="inner">

        <div class="face">
          <div class="header">
            <span id="frontTheme">Thema</span>
            <span class="pageNo" id="fNo">1</span>
          </div>
          <div class="vlabel"><span>Frage</span></div>
          <div class="content">
            <div class="question" id="fQuestion">TXT hochladenâ€¦</div>
            <div class="difficulty" id="difficulty"></div>
          </div>
        </div>

        <div class="face back">
          <div class="header">
            <span id="backTheme">Antwort</span>
            <span class="pageNo" id="bNo">1</span>
          </div>
          <div class="vlabel"><span>Antwort</span></div>
          <div class="content">
            <div class="answerWrap">
              <div class="solutionTitle" id="solutionTitle"></div>
              <div class="answerText" id="bText">â€”</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <button class="arrow right" type="button" onclick="next()">âžœ</button>
  </div>
</div>

<script>
function toggleTheme(){
  const r=document.documentElement;
  const t=r.getAttribute("data-theme")==="dark"?"":"dark";
  r.setAttribute("data-theme",t);
  localStorage.setItem("theme",t);
}
const saved=localStorage.getItem("theme");
if(saved) document.documentElement.setAttribute("data-theme",saved);

const fileInput=document.getElementById("fileInput");
const fileBtn=document.getElementById("fileBtn");
const activeFileName=document.getElementById("activeFileName");
const menu=document.getElementById("menu");
const menuList=document.getElementById("menuList");

const fQuestion=document.getElementById("fQuestion");
const bText=document.getElementById("bText");
const solutionTitle=document.getElementById("solutionTitle");

const fNo=document.getElementById("fNo");
const bNo=document.getElementById("bNo");
const counter=document.getElementById("counter");
const card=document.getElementById("card");
const diffEl=document.getElementById("difficulty");
const frontTheme=document.getElementById("frontTheme");
const backTheme=document.getElementById("backTheme");

/* ================= PARSER (FIXED FOR INVISIBLE CHARS) ================= */
function parse(txt){

  // BOM + ZeroWidth + unsichtbare Zeichen entfernen
  txt = txt
    .replace(/\uFEFF/g,"")
    .replace(/[\u200B-\u200D\u2060]/g,"");

  const lines = txt.replace(/\r/g,"").split("\n").map(x=>x.trimEnd());
  const cards=[];
  let c=null;
  let last=null;

  const KNOWN = new Set([
    "frage",
    "schwierigkeit",
    "thema",
    "text",
    "loesungs-titel",
    "loesungstitel",
    "loesungs titel",
    "loesung",
    "losung"
  ]);

  function startCard(nr){
    if(c) cards.push(c);
    c={
      nr:(nr||"").trim(),
      thema:"Thema",
      schwierigkeit:0,
      text:"",
      loesungstitel:"",
      loesung:""
    };
    last=null;
  }

  function normKey(k){
    return k
      .trim()
      .replace(/[\u2010\u2011\u2012\u2013\u2014\u2212\uFE58\uFE63\uFF0D]/g, "-") // alle Dash -> "-"
      .toLowerCase()
      .replace(/Ã¤/g,"ae").replace(/Ã¶/g,"oe").replace(/Ã¼/g,"ue")
      .replace(/ÃŸ/g,"ss")
      .replace(/\s+/g," ")
      .replace(/[^a-z0-9 \-]/g,"")
      .trim();
  }

  function appendToLast(line){
    line = line.replace(/\uFEFF/g,"").replace(/[\u200B-\u200D\u2060]/g,"");
    if(!c || !last) return;
    c[last] += (c[last] ? "\n" : "") + line;
  }

  for(let idx=0; idx<lines.length; idx++){
    let line = lines[idx].trimEnd();

    if(!line){
      // leere Zeile als Absatz im aktuellen Feld
      if(c && last) c[last] += "\n";
      continue;
    }

    const m = line.match(/^([^:]+):\s*(.*)$/);

    if(m){
      const keyRaw = m[1];
      const key = normKey(keyRaw);
      let val = (m[2] || "");

      // WICHTIG: Wenn wir gerade in Text/LÃ¶sung/LÃ¶sungstitel sind
      // und der Key NICHT bekannt ist -> das ist KEIN Feld,
      // sondern normaler Content (z.B. "Einmaligkeit: ...")
      if(c && last && !KNOWN.has(key)){
        appendToLast(line);
        continue;
      }

      // Multi-line Format:
      // Key:
      // Wert
      if(val.trim()==="" && idx+1 < lines.length){
        const nextLine = (lines[idx+1]||"").trim();
        if(nextLine && !nextLine.match(/^([^:]+):\s*(.*)$/)){
          val = nextLine;
          idx++;
        }
      }

      if(key==="frage"){
        startCard(val);
        continue;
      }
      if(!c) continue;

      if(key==="schwierigkeit"){
        c.schwierigkeit = parseInt(val,10) || 0;
        last=null;
        continue;
      }

      if(key==="thema"){
        c.thema = val.trim() || "Thema";
        last=null;
        continue;
      }

      if(key==="text"){
        c.text = val;
        last="text";
        continue;
      }

      if(key==="loesungs-titel" || key==="loesungstitel" || key==="loesungs titel"){
        c.loesungstitel = val;
        last="loesungstitel";
        continue;
      }

      if(key==="loesung" || key==="losung"){
        c.loesung = val;
        last="loesung";
        continue;
      }

      last=null;
    }else{
      // normale Zeile -> in aktuelles Feld hÃ¤ngen
      appendToLast(line);
    }
  }

  if(c) cards.push(c);
  return cards;
}

/* ================= STATE ================= */
const pre="flash_";
let cards=[];
let i=0;
let activeKey="";

/* ================= RENDER ================= */
function render(){
  if(!cards.length){
    fQuestion.textContent="TXT hochladenâ€¦";
    bText.textContent="â€”";
    solutionTitle.textContent="";
    solutionTitle.style.display="none";
    diffEl.innerHTML="";
    counter.textContent="";
    frontTheme.textContent="Thema";
    backTheme.textContent="Antwort";
    fNo.textContent="1";
    bNo.textContent="1";
    return;
  }

  const c=cards[i];

  frontTheme.textContent=c.thema || "Thema";
  backTheme.textContent=c.thema || "Antwort";

  fQuestion.textContent=(c.text||"â€”").trim();
  bText.textContent=(c.loesung||"â€”").trim();

  const st=(c.loesungstitel||"").trim();
  solutionTitle.textContent=st;
  solutionTitle.style.display = st ? "block" : "none";

  fNo.textContent=bNo.textContent=c.nr||i+1;
  counter.textContent=`Karte ${i+1} / ${cards.length}`;

  diffEl.innerHTML="";
  const lvl=Math.max(0,Math.min(3,c.schwierigkeit||0));
  for(let d=1;d<=3;d++){
    const dot=document.createElement("div");
    dot.className="dot"+(d<=lvl?" active":"");
    diffEl.appendChild(dot);
  }

  card.classList.remove("flipped");
}

/* NAV */
function next(){ if(i<cards.length-1){i++;render()} }
function prev(){ if(i>0){i--;render()} }

card.onclick=()=>card.classList.toggle("flipped");
document.onkeydown=e=>{
  if(e.key==="ArrowRight") next();
  if(e.key==="ArrowLeft") prev();
  if(e.key===" ") card.classList.toggle("flipped");
};

/* MENU */
function listKeys(){
  return Object.keys(localStorage)
    .filter(k=>k.startsWith(pre))
    .sort((a,b)=>a.localeCompare(b));
}

function refreshMenu(){
  menuList.innerHTML="";
  const keys=listKeys();

  if(!keys.length){
    const empty=document.createElement("div");
    empty.style.padding="10px";
    empty.style.opacity=".65";
    empty.style.fontWeight="800";
    empty.textContent="Keine TXT gespeichert.";
    menuList.appendChild(empty);
    return;
  }

  keys.forEach(k=>{
    const name=k.replace(pre,"");

    const row=document.createElement("div");
    row.className="menuItem";

    const left=document.createElement("div");
    left.className="menuItemName";
    left.textContent=name;

    const trash=document.createElement("button");
    trash.className="trash";
    trash.textContent="ðŸ—‘";
    trash.title="TXT lÃ¶schen";
    trash.type="button";

    function deleteFile(ev){
      ev.preventDefault();
      ev.stopPropagation();

      if(!confirm(`"${name}" wirklich lÃ¶schen?`)) return;

      localStorage.removeItem(k);

      if(activeKey===k){
        activeKey="";
        cards=[];
        i=0;
        activeFileName.textContent="TXT wÃ¤hlenâ€¦";
        render();
      }
      refreshMenu();
    }

    trash.addEventListener("click", deleteFile);
    trash.addEventListener("touchstart", deleteFile, {passive:false});

    row.onclick=()=>{
      loadFromKey(k);
      closeMenu();
    };

    row.appendChild(left);
    row.appendChild(trash);
    menuList.appendChild(row);
  });
}

function openMenu(){ refreshMenu(); menu.classList.add("open"); }
function closeMenu(){ menu.classList.remove("open"); }

fileBtn.onclick=(e)=>{
  e.stopPropagation();
  menu.classList.contains("open") ? closeMenu() : openMenu();
};

function outsideClose(e){
  if(!menu.contains(e.target) && !fileBtn.contains(e.target)){
    closeMenu();
  }
}
document.addEventListener("click", outsideClose);
document.addEventListener("touchstart", outsideClose, {passive:true});

/* LOAD */
function loadFromKey(k){
  const txt=localStorage.getItem(k);
  if(!txt) return;

  activeKey=k;
  activeFileName.textContent=k.replace(pre,"");

  cards=parse(txt);
  i=0;
  render();
}

/* UPLOAD */
fileInput.onchange=()=>{
  const files=[...fileInput.files];
  if(!files.length) return;

  files.forEach((f,idx)=>{
    const r=new FileReader();
    r.onload=()=>{
      localStorage.setItem(pre+f.name,r.result);
      if(idx===0) loadFromKey(pre+f.name);
    };
    r.readAsText(f,"utf-8");
  });

  fileInput.value="";
};

/* INIT */
render();
refreshMenu();
</script>
</body>
</html>
