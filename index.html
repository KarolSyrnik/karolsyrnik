<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Karteikarten (offline)</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --panel:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#d9dde3;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --btn:#111;
      --btnText:#fff;
      --danger:#c62828;
      --accent:#111;
      --focus: rgba(17,17,17,.14);
    }
    [data-theme="dark"]{
      --bg:#000;
      --panel:#0f0f10;
      --text:#fff;
      --muted:#b8b8b8;
      --border:#2a2a2a;
      --shadow: 0 10px 30px rgba(0,0,0,.65);
      --btn:#fff;
      --btnText:#000;
      --danger:#ff5b5b;
      --accent:#fff;
      --focus: rgba(255,255,255,.14);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      background:var(--bg);
      padding:12px 12px 10px;
    }
    .topbar-inner{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      max-width:1100px;
      margin:0 auto;
    }
    .group{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      min-width:0;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      line-height:1;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      background:var(--btn);
      color:var(--btnText);
      border-color:transparent;
    }
    .btn.icon{
      width:42px;
      height:42px;
      justify-content:center;
      padding:0;
      border-radius:14px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px var(--focus);
    }
    .ico{
      width:18px;
      height:18px;
      display:inline-block;
      vertical-align:middle;
      color: currentColor;
    }
    .ico.big{ width:20px; height:20px; }
    .stroke{
      fill:none;
      stroke:currentColor;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .dd{
      position:relative;
      width: min(520px, 78vw);
      max-width: min(560px, 84vw);
      min-width: min(320px, 74vw);
    }
    .dd-btn{
      width:100%;
      justify-content:space-between;
      padding:12px 12px 12px 14px;
      border-radius:16px;
    }
    .dd-btn .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dd-btn .name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:650;
    }
    .dd-btn .meta{
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      white-space:nowrap;
    }
    .dd-btn .caret{
      color:var(--muted);
      font-size:14px;
      margin-left:10px;
    }
    .dd-menu{
      position:absolute;
      left:0;
      right:0;
      top: calc(100% + 10px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      max-height: min(56vh, 420px);
    }
    .dd.open .dd-menu{ display:block; }
    .dd-list{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      max-height: min(56vh, 420px);
    }
    .dd-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-bottom:1px solid var(--border);
    }
    .dd-item:last-child{ border-bottom:none; }
    .dd-item-main{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      cursor:pointer;
      padding:6px 8px;
      border-radius:14px;
      -webkit-tap-highlight-color: transparent;
    }
    .dd-item-main:hover{ background: rgba(0,0,0,.04); }
    [data-theme="dark"] .dd-item-main:hover{ background: rgba(255,255,255,.06); }
    .dd-item-title{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .dd-item-title .tname{
      font-weight:750;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius:999px;
      background: transparent;
      flex: 0 0 auto;
    }
    .dd-item-sub{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dd-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .mini{
      width:40px;
      height:40px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .mini:hover{ background: rgba(0,0,0,.04); }
    [data-theme="dark"] .mini:hover{ background: rgba(255,255,255,.06); }
    .mini.danger{
      color: var(--danger);
      border-color: transparent;
    }
    .mini.danger:hover{ background: rgba(198,40,40,.08); }
    [data-theme="dark"] .mini.danger:hover{ background: rgba(255,91,91,.10); }
    .dd-footer{
      padding:10px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .dd-footer .small{
      color:var(--muted);
      font-size:12px;
    }
    .hint{
      max-width:1100px;
      margin:6px auto 0;
      padding:0 2px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .stage{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 10px 24px;
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:center;
      width: min(18vw, 120px);
      min-width: 54px;
      height: min(70vh, 520px);
    }
    .arrow{
      border:none;
      background:transparent;
      color:var(--accent);
      font-size: min(9vh, 70px);
      line-height:1;
      cursor:pointer;
      padding: 12px 8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .arrow.left{ transform: scaleX(-1); }
    .arrow[disabled]{ opacity:.25; cursor:default; }
    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      width: min(92vw, 860px);
    }
    .card-wrap{
      perspective: 1200px;
      width: 14cm;
      height: 10cm;
      max-width: 92vw;
      max-height: 66vh;
      aspect-ratio: 14 / 10;
      transition: transform 0.28s ease-out;
      touch-action: pan-y;
      user-select: none;
    }
    .card{
      width:100%;
      height:100%;
      position:relative;
      transform-style:preserve-3d;
      transition: transform .55s cubic-bezier(.2,.8,.2,1);
      border-radius:20px;
      box-shadow: var(--shadow);
      will-change: transform, opacity;
    }
    .card.flipped{ transform: rotateY(180deg); }
    .face{
      position:absolute;
      inset:0;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px;
      backface-visibility:hidden;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      min-width:0;
      transition: opacity 0.4s ease;
    }
    .face.front { opacity: 1; }
    .face.back  { opacity: 0; transform: rotateY(180deg); }
    .card.flipped .face.front { opacity: 0; }
    .card.flipped .face.back  { opacity: 1; }
    .card-wrap.swiping-left  { transform: translateX(-12%) rotateY(-8deg); }
    .card-wrap.swiping-right { transform: translateX( 12%) rotateY( 8deg); }
    .header{
      height: 44px;
      min-height:44px;
      display:flex;
      align-items:center;
      padding: 0 14px 0 54px;
      border-bottom:1px solid var(--border);
      font-weight:800;
      letter-spacing:.2px;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex: 0 0 auto;
    }
    .content-area{
      position:relative;
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      min-width:0;
      overflow:hidden;
    }
    .side-label{
      position:absolute;
      left: 10px;
      top:50%;
      transform: translateY(-50%) rotate(180deg);
      writing-mode: vertical-rl;
      font-weight:900;
      letter-spacing: .8px;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
      pointer-events:none;
      z-index:2;
    }
    .scroll{
      flex:1;
      min-height:0;
      min-width:0;
      padding: 12px 14px 10px 54px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      position: relative;
      z-index:1;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }
    .scroll, .scroll *{
      -webkit-user-select: text;
      user-select: text;
    }
    .main-text{
      font-size: 18px;
      line-height:1.35;
      text-align:center;
      color: var(--text);
      word-break: break-word;
      white-space: pre-wrap;
    }
    .inline-img{
      width: 100%;
      max-width: 100%;
      height:auto;
      max-height: 260px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
    }
    .difficulty{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin-top: 2px;
      flex: 0 0 auto;
    }
    .dot{
      width:12px;
      height:12px;
      border-radius:999px;
      border: 2px solid var(--muted);
      opacity:.85;
    }
    .dot.filled{
      border-color: var(--accent);
      background: var(--accent);
      opacity:1;
    }
    .footer{
      height: 54px;
      min-height:54px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 14px 0 14px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      gap:12px;
      flex: 0 0 auto;
    }
    .footer .meta{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    .kbd{
      border:1px solid var(--border);
      border-bottom-width:2px;
      padding:2px 6px;
      border-radius:8px;
      font-size:11px;
      color:var(--muted);
      background: var(--panel);
      white-space:nowrap;
    }
    .empty{
      text-align:center;
      color:var(--muted);
      padding: 18px;
      border:1px dashed var(--border);
      border-radius:18px;
      width:min(520px, 92vw);
      background: transparent;
    }
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      padding: 14px;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      width: min(720px, 96vw);
      max-height: min(78vh, 720px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .modal-header{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modal-body{
      padding: 12px 12px 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .img-row{
      display:flex;
      gap:12px;
      align-items:center;
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
    }
    .img-thumb{
      width: 74px;
      height: 54px;
      border-radius: 12px;
      border:1px solid var(--border);
      object-fit: cover;
      flex: 0 0 auto;
      background: transparent;
    }
    .img-info{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .img-name{
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .img-sub{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .modal-footer{
      border-top: 1px solid var(--border);
      padding: 12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      align-items:center;
    }
    @media (max-width: 520px){
      .topbar{ padding: 10px 10px 8px; }
      .dd{ min-width: 62vw; }
      .btn{ padding: 10px 10px; }
      .btn.icon{ width:40px; height:40px; }
      .arrow{ font-size: 56px; }
      .header{ height: 42px; min-height:42px; font-size: 14px; padding-left: 50px; }
      .scroll{ padding-left: 50px; }
      .main-text{ font-size: 16px; }
      .inline-img{ max-height: 180px; }
      .side-label{ left: 9px; font-size: 11px; }
      .footer{ height: 52px; min-height:52px; }
      .mini{ width:38px; height:38px; }
      .img-thumb{ width: 64px; height: 48px; }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="group" style="flex:1;">
        <div class="dd" id="dd">
          <button class="btn dd-btn" id="ddBtn" type="button" aria-haspopup="listbox" aria-expanded="false">
            <div class="left">
              <span id="ddTitle" class="name">Keine TXT geladen</span>
              <span id="ddMeta" class="meta"></span>
            </div>
            <span class="caret">▾</span>
          </button>
          <div class="dd-menu" id="ddMenu">
            <div class="dd-list" id="ddList"></div>
            <div class="dd-footer">
              <div class="small">Jede TXT hat ihre eigenen Bilder (IndexedDB).</div>
              <button class="btn primary" id="btnUploadTxt" type="button">TXT Upload</button>
            </div>
          </div>
        </div>
      </div>
      <div class="group">
        <button class="btn icon" id="btnTheme" type="button" title="Theme wechseln">
          <span id="themeIcon"></span>
        </button>
      </div>
    </div>
    <div class="hint">
      <div id="statusLeft">Offline • Lokal gespeichert</div>
      <div id="statusRight" style="text-align:right;">Tap Mitte = Flip • Swipe ←→ = Karte wechseln</div>
    </div>
  </div>
  <div class="stage">
    <div class="nav">
      <button class="arrow left" id="prevBtn" type="button" aria-label="Vorherige Karte">➜</button>
    </div>
    <div class="center">
      <div id="emptyState" class="empty" style="display:none;">
        <div style="font-weight:900; color:var(--text); margin-bottom:6px;">Keine Karteikarten</div>
        <div>Upload eine oder mehrere <b>.txt</b> Dateien.</div>
      </div>
      <div class="card-wrap" id="cardWrap" style="display:none;">
        <div class="card" id="card" role="button" aria-label="Karte umdrehen oder wischen" tabindex="0">
          <div class="face front">
            <div class="header" id="topicFront">Thema</div>
            <div class="content-area">
              <div class="side-label">Frage</div>
              <div class="scroll" id="scrollFront">
                <div class="main-text" id="textFront"></div>
                <div class="difficulty" id="diffFront">
                  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
              </div>
            </div>
            <div class="footer">
              <div class="meta" id="metaFront">—</div>
              <div class="kbd">Tap / Swipe</div>
            </div>
          </div>
          <div class="face back">
            <div class="header" id="topicBack">Thema</div>
            <div class="content-area">
              <div class="side-label">Antwort</div>
              <div class="scroll" id="scrollBack">
                <div class="main-text" id="textBack"></div>
                <div class="difficulty" id="diffBack">
                  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
              </div>
            </div>
            <div class="footer">
              <div class="meta" id="metaBack">—</div>
              <div class="kbd">Esc = Flip zurück</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="nav">
      <button class="arrow" id="nextBtn" type="button" aria-label="Nächste Karte">➜</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="imgModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="imgModalTitle">
    <div class="modal-header">
      <div class="modal-title" id="imgModalTitle">Bilder</div>
      <button class="btn icon" id="btnCloseImgModal" type="button" title="Schließen">
        <span id="closeIcon"></span>
      </button>
    </div>
    <div class="modal-body" id="imgModalBody"></div>
    <div class="modal-footer">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn primary" id="btnAddImagesModal" type="button">
          <span id="addImgIcon"></span>
          <span>Bilder hinzufügen</span>
        </button>
        <button class="btn" id="btnDeleteAllImages" type="button">
          <span id="trashAllIcon"></span>
          <span>Alle löschen</span>
        </button>
      </div>
      <div style="color:var(--muted); font-size:12px;" id="imgModalCount">—</div>
    </div>
  </div>
</div>

<input id="txtInput" type="file" accept=".txt,text/plain" multiple style="display:none;" />
<input id="imgInput" type="file" accept="image/*" multiple style="display:none;" />

<script>
(() => {
  const LS_LIST_KEY = "fc_txt_list_v6";
  const LS_THEME_KEY = "fc_theme_v1";
  const LS_LAST_TXT_KEY = "fc_last_txt_v1";
  const LS_CONTENT_PREFIX = "fc_txt_content_v1_";

  const dd = document.getElementById("dd");
  const ddBtn = document.getElementById("ddBtn");
  const ddList = document.getElementById("ddList");
  const ddTitle = document.getElementById("ddTitle");
  const ddMeta = document.getElementById("ddMeta");
  const btnUploadTxt = document.getElementById("btnUploadTxt");
  const btnTheme = document.getElementById("btnTheme");
  const themeIcon = document.getElementById("themeIcon");
  const txtInput = document.getElementById("txtInput");
  const imgInput = document.getElementById("imgInput");
  const emptyState = document.getElementById("emptyState");
  const cardWrap = document.getElementById("cardWrap");
  const cardEl = document.getElementById("card");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const topicFront = document.getElementById("topicFront");
  const topicBack = document.getElementById("topicBack");
  const textFront = document.getElementById("textFront");
  const textBack = document.getElementById("textBack");
  const diffFront = document.getElementById("diffFront");
  const diffBack = document.getElementById("diffBack");
  const metaFront = document.getElementById("metaFront");
  const metaBack = document.getElementById("metaBack");
  const statusLeft = document.getElementById("statusLeft");
  const scrollFront = document.getElementById("scrollFront");
  const scrollBack = document.getElementById("scrollBack");

  const imgModalBackdrop = document.getElementById("imgModalBackdrop");
  const imgModalBody = document.getElementById("imgModalBody");
  const imgModalTitle = document.getElementById("imgModalTitle");
  const imgModalCount = document.getElementById("imgModalCount");
  const btnCloseImgModal = document.getElementById("btnCloseImgModal");
  const btnAddImagesModal = document.getElementById("btnAddImagesModal");
  const btnDeleteAllImages = document.getElementById("btnDeleteAllImages");
  const addImgIcon = document.getElementById("addImgIcon");
  const trashAllIcon = document.getElementById("trashAllIcon");
  const closeIcon = document.getElementById("closeIcon");

  let txtList = [];
  let currentTxtId = "";
  let currentTxtName = "";
  let cards = [];
  let idx = 0;
  let isFlipped = false;

  // Gesture Variablen
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  let touchStartTime = 0;

  const SWIPE_THRESHOLD = 60;
  const SWIPE_VERT_TOLERANZ = 70;
  const TAP_MAX_DURATION = 300;
  const TAP_MAX_MOVE = 25;

  function isInsideScroll(el) {
    return !!(el && el.closest && el.closest(".scroll"));
  }

  function handleStart(e) {
    if (isInsideScroll(e.target)) return;

    const touch = e.touches ? e.touches[0] : e;
    touchStartX     = touch.clientX;
    touchStartY     = touch.clientY;
    touchEndX       = touchStartX;
    touchEndY       = touchStartY;
    touchStartTime  = Date.now();

    cardWrap.classList.remove("swiping-left", "swiping-right");
  }

  function handleMove(e) {
    if (touchStartX === 0) return;
    if (isInsideScroll(e.target)) return;

    const touch = e.touches ? e.touches[0] : e;
    touchEndX = touch.clientX;
    touchEndY = touch.clientY;

    const deltaX = touchEndX - touchStartX;

    cardWrap.classList.remove("swiping-left", "swiping-right");
    if (Math.abs(deltaX) > 20) {
      cardWrap.classList.toggle("swiping-left",  deltaX < 0);
      cardWrap.classList.toggle("swiping-right", deltaX > 0);
    }
  }

  function handleEnd(e) {
    if (touchStartX === 0) return;

    const deltaX     = touchEndX - touchStartX;
    const deltaY     = touchEndY - touchStartY;
    const absDeltaX  = Math.abs(deltaX);
    const absDeltaY  = Math.abs(deltaY);
    const duration   = Date.now() - touchStartTime;

    cardWrap.classList.remove("swiping-left", "swiping-right");

    // Swipe → Karte wechseln
    if (absDeltaX >= SWIPE_THRESHOLD && absDeltaY <= SWIPE_VERT_TOLERANZ) {
      if (deltaX < 0) {
        if (idx < cards.length - 1) {
          idx++;
          renderCard();
        }
      } else {
        if (idx > 0) {
          idx--;
          renderCard();
        }
      }
      resetTouch();
      return;
    }

    // Kurzer Tap → Flip
    if (duration <= TAP_MAX_DURATION &&
        absDeltaX <= TAP_MAX_MOVE &&
        absDeltaY <= TAP_MAX_MOVE) {
      flip();
    }

    resetTouch();
  }

  function resetTouch() {
    touchStartX = touchStartY = touchEndX = touchEndY = touchStartTime = 0;
  }

  function attachGestureListeners() {
    const target = cardWrap;

    target.addEventListener('touchstart',  handleStart,   { passive: true });
    target.addEventListener('touchmove',   handleMove,    { passive: true });
    target.addEventListener('touchend',    handleEnd,     { passive: true });
    target.addEventListener('touchcancel', resetTouch,    { passive: true });

    target.addEventListener('mousedown',   handleStart);
    document.addEventListener('mousemove', handleMove);
    document.addEventListener('mouseup',   handleEnd);
    document.addEventListener('mouseleave',resetTouch);
  }

  // ────────────────────────────────────────────────
  // Rest des Codes (Icons, IndexedDB, Parser, Render usw.)
  // ────────────────────────────────────────────────

  function svgPhoto(){ return `<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><rect class="stroke" x="3" y="5" width="18" height="14" rx="2"/><path class="stroke" d="M7 15l3-3 3 3 3-4 2 4"/><circle class="stroke" cx="9" cy="9" r="1.2"/></svg>`; }
  function svgTrash(){ return `<svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path class="stroke" d="M4 7h16"/><path class="stroke" d="M10 11v7"/><path class="stroke" d="M14 11v7"/><path class="stroke" d="M6 7l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"/><path class="stroke" d="M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3"/></svg>`; }
  function svgSun(){ return `<svg class="ico big" viewBox="0 0 24 24" aria-hidden="true"><circle class="stroke" cx="12" cy="12" r="4"/><path class="stroke" d="M12 2v2"/><path class="stroke" d="M12 20v2"/><path class="stroke" d="M4.93 4.93l1.41 1.41"/><path class="stroke" d="M17.66 17.66l1.41 1.41"/><path class="stroke" d="M2 12h2"/><path class="stroke" d="M20 12h2"/><path class="stroke" d="M4.93 19.07l1.41-1.41"/><path class="stroke" d="M17.66 6.34l1.41-1.41"/></svg>`; }
  function svgMoonStars(){ return `<svg class="ico big" viewBox="0 0 24 24" aria-hidden="true"><path class="stroke" d="M20.5 15.5A8 8 0 0 1 9.5 3.5a7 7 0 1 0 11 12z"/><path class="stroke" d="M5.2 6.2l.7 1.3 1.3.7-1.3.7-.7 1.3-.7-1.3-1.3-.7 1.3-.7.7-1.3z"/><path class="stroke" d="M17.2 6.5l.5 1 .9.5-.9.5-.5 1-.5-1-.9-.5.9-.5.5-1z"/></svg>`; }
  function svgClose(){ return `<svg class="ico big" viewBox="0 0 24 24" aria-hidden="true"><path class="stroke" d="M6 6l12 12"/><path class="stroke" d="M18 6l-12 12"/></svg>`; }
  function badgeImages(){ return `<span class="badge" title="Diese TXT hat Bilder">${svgPhoto()}<span>Bilder</span></span>`; }

  const DB_NAME = "flashcards_images_v6";
  const DB_VERSION = 1;
  const STORE = "images";

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          const store = db.createObjectStore(STORE, { keyPath: "key" });
          store.createIndex("byTxt", "txtId", { unique: false });
          store.createIndex("byTxtName", ["txtId","name"], { unique: true });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  // ... (die restlichen IndexedDB-Funktionen idbPutImage, idbGetImage, idbListImagesForTxt usw. bleiben identisch wie in vorherigen Versionen)

  function loadTxtList(){
    try{
      const raw = localStorage.getItem(LS_LIST_KEY);
      txtList = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(txtList)) txtList = [];
    }catch{
      txtList = [];
    }
  }

  function saveTxtList(){ localStorage.setItem(LS_LIST_KEY, JSON.stringify(txtList)); }
  function saveTxtContent(id, content){ localStorage.setItem(LS_CONTENT_PREFIX + id, content); }
  function getTxtContent(id){ return localStorage.getItem(LS_CONTENT_PREFIX + id) || ""; }
  function deleteTxtContent(id){ localStorage.removeItem(LS_CONTENT_PREFIX + id); }
  function makeId(){ return "t" + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

  // parseTXT, renderMixedFlow, setDots, setEmptyUI, clampIndex, updateNavButtons, renderCard usw. bleiben gleich

  function flip(){
    if (!cards.length) return;
    isFlipped = !isFlipped;
    cardEl.classList.toggle("flipped", isFlipped);
  }

  // ... (Theme, Dropdown, Modal, Upload-Logik, deleteTxt usw. bleiben gleich)

  async function init(){
    applyTheme(localStorage.getItem(LS_THEME_KEY) || "light");
    loadTxtList();
    await refreshTxtMetaFromDB();
    renderDDList();
    const last = localStorage.getItem(LS_LAST_TXT_KEY) || "";
    const initialId = (last && txtList.some(t => t.id === last)) ? last : (txtList[0]?.id || "");
    await selectTxt(initialId);
    setDDHeader();
    setThemeIcon();

    attachGestureListeners();
  }

  init();
})();
</script>
</body>
</html>